<% content_for :title, "Child Benefit tax calculator" %>

<%= render 'govuk_component/title', title: "Child Benefit tax calculator" %>

<div class="grid-row">
  <article role="article" class="column-two-thirds">
    <%= form_tag("process_form", :method => :get, :id => "child_benefit_tax_calculator", :class => "calculator") do %>
      <!-- hidden field to store the tax year so it can persist -->
      <input type="hidden" name="year" value="<%= params[:year] %>" />

      <% if @calculator.has_errors? -%>
        <div role="group" aria-labelledby="errorHeading" tabindex="-1" class="validation-summary">
          <h2 id="errorHeading">Please check the form</h2>
          <ul>
            <%# TODO: This could be tidied up into a model or helper method %>
            <% @calculator.starting_children.map(&:errors).map(&:messages).map(&:values).flatten.uniq.each do |message| -%>
              <li><a href="#children"><%= message %></a></li>
            <% end -%>
            <% @calculator.errors.each do |key, message| -%>
              <li><a href="#tax-year"><%= message %></a></li>
            <% end -%>
          </ul>
        </div>
      <% end -%>

      <fieldset>
        <%= step(1, "How many children do you want to claim Child Benefit for?") %>
        <label for="children_count" class="visuallyhidden">Number of children</label>
        <%= select_tag "children_count", options_for_select((1..10).collect{|n| [n,n]}, @calculator.children_count), :class => "form-control" %>
        <%= submit_tag "Update", :name => "children", :class => "js-hidden button update-button" %>
      </fieldset>

      <fieldset id="tax-year">
        <%= step(2, "Which tax year are you claiming for?") %>
        <p>Tax years run from 6 April to 5 April the following year.</p>
        <div class="tax-year<% if @calculator.errors.has_key?(:tax_year) %> validation-error<% end %>">
          <% @calculator.errors[:tax_year].each do |message| %>
            <p><%= message %></p>
          <% end -%>
          <% ChildBenefitTaxCalculator::TAX_YEARS.keys.each do |year| -%>
            <label for="year_<%= year %>" class="selectable">
              <%= radio_button_tag "year", year, (@calculator.tax_year == year.to_i) %>
              <%= tax_year_label(year) %>
            </label>
          <% end -%>
        </div>
      </fieldset>

      <fieldset id="is-part-year-claim">
        <%= step(3, "Are you claiming for only a part of the tax year for any of your children?") %>
        <div class="is-part-year-claim<% if @calculator.errors.has_key?(:is_part_year_claim) %> validation-error<% end %>">
          <% @calculator.errors[:is_part_year_claim].each do |message| %>
            <p><%= message %></p>
          <% end -%>
          <% ["yes", "no"].each do |option| -%>
            <label for="is_part_year_claim_<%= option %>" class="selectable">
              <%= radio_button_tag "is_part_year_claim", option, (@calculator.is_part_year_claim == option) %>
              <%= option.capitalize %>
            </label>
          <% end -%>
        </div>
      </fieldset>

      <fieldset class="adjusted-income">
        <%= step(4, "Enter your income details for the tax year (optional):") %>
        <ul class="list list-bullet">
          <li>don’t combine your household income</li>
          <li>use your partner’s income if it’s higher than yours</li>
          <li>you can get some of this information from your P60, P11D, employer or tax adviser</li>
        </ul>
        <div class="form-group">
        <%= label_tag "gross_income", "Salary before tax", :class=> "form-label" %>
        <%= money_input "gross_income", @adjusted_net_income_calculator.gross_income, 'aria-describedby' => 'step-4-description', :class=> "form-control" %>
        </div>
        <div class="form-group">
        <%= label_tag "other_income", "Other employment income - for example taxable benefits (like a company car or medical insurance) or bonuses" %>
        <%= money_input "other_income", @adjusted_net_income_calculator.other_income, 'aria-describedby' => 'step-4-description', :class=> "form-control" %>
        </div>
        <div class="form-group">
        <%= label_tag "pension_contributions_from_pay", "Pension contributions deducted from your pay (don't include contributions deducted before tax)" %>
        <%= money_input "pension_contributions_from_pay", @adjusted_net_income_calculator.pension_contributions_from_pay, 'aria-describedby' => 'step-4-description', :class=> "form-control" %>
        </div>
        <div class="form-group">
        <%= label_tag "retirement_annuities", "Retirement annuity contracts" %>
        <%= money_input "retirement_annuities", @adjusted_net_income_calculator.retirement_annuities, 'aria-describedby' => 'step-4-description', :class=> "form-control" %>
        </div>
        <div class="form-group">
        <%= label_tag "cycle_scheme", "Cycle scheme" %>
        <%= money_input "cycle_scheme", @adjusted_net_income_calculator.cycle_scheme, 'aria-describedby' => 'step-4-description', :class=> "form-control" %>
        </div>
        <div class="form-group">
        <%= label_tag "childcare", "Childcare paid directly by your employer - for example childcare vouchers (for the whole year but no more than £55 a week) or the value of any workplace nursery places" %>
        <%= money_input "childcare", @adjusted_net_income_calculator.childcare, 'aria-describedby' => 'step-4-description', :class=> "form-control" %>
        </div>
        <div class="form-group">
        <%= label_tag "pensions", "Income from pension(s) - for example from a state pension" %>
        <%= money_input "pensions", @adjusted_net_income_calculator.pensions, 'aria-describedby' => 'step-4-description', :class=> "form-control" %>
        </div>
        <div class="form-group">
        <%= label_tag "property", "Income from property - for example rental income" %>
        <%= money_input "property", @adjusted_net_income_calculator.property, 'aria-describedby' => 'step-4-description', :class=> "form-control" %>
        </div>
        <div class="form-group">
        <%= label_tag "non_employment_income", "Other income before tax - for example profits from self-employment, taxable savings, dividends" %>
        <%= money_input "non_employment_income", @adjusted_net_income_calculator.non_employment_income, 'aria-describedby' => 'step-4-description', :class=> "form-control" %>
        </div>
        <div class="form-group">
        <%= label_tag "gift_aid_donations", "Gift Aid donations" %>
        <%= money_input "gift_aid_donations", @adjusted_net_income_calculator.gift_aid_donations, 'aria-describedby' => 'step-4-description', :class=> "form-control" %>
        </div>
        <div class="form-group">
        <%= label_tag "outgoing_pension_contributions", "Pension contributions not paid from your salary (the amount you actually paid, not the grossed-up amount)" %>
        <%= money_input "outgoing_pension_contributions", @adjusted_net_income_calculator.outgoing_pension_contributions, 'aria-describedby' => 'step-4-description', :class=> "form-control" %>
        </div>

      <%= submit_tag "Calculate", :name => "results", :class => "button" %>
      </fieldset>
    <% end %>
    <div id="children-template" style="display:none">
      <div class="part-year-children-count">
        <h2 class="heading-medium">How many children do you want to claim only a part of the tax year for?</h2>
        <label for="part_year_children_count" class="visuallyhidden">Number of part year children</label>
        <%= select_tag "part_year_children_count", options_for_select((1..10).collect{|n| [n,n]}, @calculator.part_year_children_count), :class => "form-control" %>
        <%= submit_tag "Update Children", :name => "children", :class => "button update-button js-hidden" %>
      </div>

      <h2 class="heading-medium">Enter the Child Benefit start and stop dates:</h2>
      <ul class="list list-bullet">
        <li>you can find the start date on your Child Benefit award notice</li>
        <li>the stop date is usually when a child turns 16 or leaves full-time education</li>
      </ul>
      <div class="grid-row">
        <%= render "starting_children" %>
      </div>
    </div>

    <% if can_haz_results? %>
    <div class="results">
      <h2 id="results" class="heading-large">Results</h2>
      <%= render "results" %>
    </div>
    <% end %>
  </article>
</div>
